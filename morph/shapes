#!/bin/bash

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
MORPH_DIR="$SCRIPT_DIR"
PFAEDLE_DIR="$MORPH_DIR/pfaedle"
MORPH_TMP_DIR="$MORPH_DIR/../.tmp/morph"
OSM_DIR="$MORPH_TMP_DIR/osm"
GTFS_SHAPED_DIR="$MORPH_TMP_DIR/shaped"
CONFIG_PATH="$MORPH_DIR/pfaedle.cfg"
GTFS_DIR="$MORPH_DIR/../gtfs"
PREVIOUS_GTFS_DIR="$MORPH_DIR/../.tmp/previous-gtfs"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${BLUE}Morph GTFS Shape Generator${NC}"
    echo ""
    echo "Usage: shapes [command] [options]"
    echo ""
    echo "Commands:"
    echo "  init              Build pfaedle and download OSM data"
    echo "  add [options] [gtfs] [osm]  Add shapes to a GTFS file"
    echo "  all [options]     Process all GTFS files"
    echo ""
    echo "Options for 'add' and 'all':"
    echo "  --overwrite       Replace the original GTFS file with the shaped version"
    echo "  --backup          Replace the original GTFS file but save a copy as [filename].lite.zip"
    echo "  --force           Force shape generation even if file hasn't changed"
    echo "  --jobs=N          Number of parallel jobs to run (default: number of CPU cores)"
    echo ""
    echo "Arguments:"
    echo "  [gtfs]            Path to GTFS file"
    echo "  [osm]             Path to OSM file (default: .tmp/morph/osm/latest.osm)"
}

build_pfaedle() {
    if [ ! -f "$PFAEDLE_DIR/build/pfaedle" ]; then
        echo -e "${BLUE}Building pfaedle...${NC}"
        mkdir -p "$PFAEDLE_DIR/build"
        cd "$PFAEDLE_DIR/build" || exit 1
        cmake ..
        make -j
        cd - > /dev/null || exit 1
        echo -e "${GREEN}pfaedle built successfully${NC}"
    else
        echo -e "${GREEN}pfaedle already built${NC}"
    fi
}

download_osm() {
    mkdir -p "$OSM_DIR"

    local merged_file="$OSM_DIR/latest.osm"
    local merged_file_compressed="$OSM_DIR/latest.osm.bz2"

    if [ -f "$merged_file_compressed" ] && [ ! -f "$merged_file" ]; then
        echo -e "${BLUE}Found cached compressed OSM data. Decompressing...${NC}"
        pbzip2 -dk "$merged_file_compressed"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}Successfully decompressed cached OSM data${NC}"
            return
        else
            echo -e "${RED}Failed to decompress cached OSM data, downloading fresh copy${NC}"
        fi
    fi

    if [ -f "$merged_file" ]; then
        echo -e "${GREEN}Merged OSM data already exists${NC}"
        return
    fi

    local countries=(
        "slovakia-latest.osm.bz2"
        "czech-republic-latest.osm.bz2"
        "austria-latest.osm.bz2"
    )

    local osmconvert_path="$OSM_DIR/osmconvert64"

    if [ ! -f "$osmconvert_path" ]; then
        echo -e "${BLUE}Downloading osmconvert...${NC}"
        wget -q --show-progress "http://m.m.i24.cc/osmconvert64" -O "$osmconvert_path"
        chmod +x "$osmconvert_path"
        echo -e "${GREEN}osmconvert downloaded${NC}"
    fi

    local osm_files=()

    for country in "${countries[@]}"; do
        local osm_file_zip="$OSM_DIR/$country"
        local osm_file="${osm_file_zip%.bz2}"

        if [ ! -f "$osm_file" ]; then
            if [ ! -f "$osm_file_zip" ]; then
                echo -e "${BLUE}Downloading OSM data for ${country%.osm.bz2}...${NC}"
                wget --show-progress --timeout=60 --tries=2 --retry-connrefused "https://download.geofabrik.de/europe/$country" -O "$osm_file_zip"
            fi

            echo -e "${BLUE}Unzipping OSM data for ${country%.osm.bz2}...${NC}"
            pbzip2 -d "$osm_file_zip"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}OSM data for ${country%.osm.bz2} unzipped successfully${NC}"
                osm_files+=("$osm_file")
            else
                echo -e "${RED}Failed to unzip OSM data for ${country%.osm.bz2}${NC}"
                continue
            fi
        else
            echo -e "${GREEN}OSM data for ${country%.osm.bz2} already exists${NC}"
            osm_files+=("$osm_file")
        fi
    done

    echo -e "${BLUE}Merging OSM files...${NC}"
    "$osmconvert_path" "${osm_files[@]}" -o="$merged_file"

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}OSM files merged successfully into $merged_file${NC}"

        echo -e "${BLUE}Setting merged file as default for shape generation${NC}"
    else
        echo -e "${RED}Failed to merge OSM files${NC}"
        exit 1
    fi

    for osm_file in "${osm_files[@]}"; do
        if [ -f "$osm_file" ]; then
            rm "$osm_file"
            echo -e "${BLUE}Removed OSM file: $osm_file${NC}"
        fi
    done
}

compare_gtfs_content() {
    local file1="$1"
    local file2="$2"
    local tmp_dir1=$(mktemp -d)
    local tmp_dir2=$(mktemp -d)

    unzip -qq "$file1" -d "$tmp_dir1"
    unzip -qq "$file2" -d "$tmp_dir2"

    local content_checksum1=$(find "$tmp_dir1" -type f -name "*.txt" | sort | xargs md5sum 2>/dev/null | awk '{print $1}' | md5sum | cut -d ' ' -f 1)
    local content_checksum2=$(find "$tmp_dir2" -type f -name "*.txt" | sort | xargs md5sum 2>/dev/null | awk '{print $1}' | md5sum | cut -d ' ' -f 1)

    rm -rf "$tmp_dir1" "$tmp_dir2"

    if [ "$content_checksum1" = "$content_checksum2" ]; then
        return 0
    else
        return 1
    fi
}

add_shapes() {
    local overwrite=false
    local backup=false
    local force=false
    local args=()

    for arg in "$@"; do
        if [ "$arg" = "--overwrite" ]; then
            overwrite=true
        elif [ "$arg" = "--backup" ]; then
            backup=true
        elif [ "$arg" = "--force" ]; then
            force=true
        else
            args+=("$arg")
        fi
    done

    local gtfs_file="${args[0]}"
    local osm_file="${args[1]}"

    if [ -z "$gtfs_file" ]; then
        echo -e "${RED}Error: GTFS file not specified${NC}"
        show_help
        exit 1
    fi

    if [ ! -f "$gtfs_file" ]; then
        echo -e "${RED}Error: GTFS file not found: $gtfs_file${NC}"
        exit 1
    fi

    local agency=$(basename "$gtfs_file" .zip)
    local country_code=$(basename "$(dirname "$gtfs_file")")

    mkdir -p "$PREVIOUS_GTFS_DIR"

    local previous_lite_file="$PREVIOUS_GTFS_DIR/${country_code}/${agency}.lite.zip"
    local previous_shaped_file="$PREVIOUS_GTFS_DIR/${country_code}/${agency}.zip"

    if [ -f "$previous_lite_file" ] && [ "$force" = false ]; then
        echo -e "${BLUE}Found previous lite version. Comparing GTFS content...${NC}"

        if compare_gtfs_content "$gtfs_file" "$previous_lite_file"; then
            echo -e "${GREEN}GTFS content matches. Skipping shape generation.${NC}"

            if [ "$overwrite" = true ] || [ "$backup" = true ]; then
                if [ -f "$previous_shaped_file" ]; then
                    echo -e "${BLUE}Applying previously generated shapes to current file...${NC}"

                    local tmp_current=$(mktemp -d)
                    local tmp_shaped=$(mktemp -d)
                    local tmp_output=$(mktemp -d)
                    local tmp_zip="$tmp_output/shaped.zip"

                    unzip -qq "$gtfs_file" -d "$tmp_current"
                    unzip -qq "$previous_shaped_file" -d "$tmp_shaped"

                    cp -r "$tmp_current"/* "$tmp_output/"

                    if [ -f "$tmp_shaped/shapes.txt" ]; then
                        cp "$tmp_shaped/shapes.txt" "$tmp_output/"
                        echo -e "${GREEN}Successfully copied shapes.txt from previous shaped version${NC}"
                    else
                        echo -e "${YELLOW}No shapes.txt found in previous shaped version${NC}"
                    fi

                    (cd "$tmp_output" && find . -type f | sort | zip -X "$tmp_zip" -@)

                    if [ "$backup" = true ]; then
                        echo -e "${YELLOW}Backing up original GTFS file...${NC}"
                        local backup_file="${gtfs_file%.zip}.lite.zip"
                        cp "$gtfs_file" "$backup_file"
                        echo -e "${GREEN}Original GTFS backed up to $backup_file${NC}"
                    fi

                    cp "$tmp_zip" "$gtfs_file"
                    echo -e "${GREEN}Successfully applied shapes to $gtfs_file${NC}"

                    cp "$gtfs_file" "$previous_lite_file"
                    cp "$tmp_zip" "$previous_shaped_file"

                    rm -rf "$tmp_current" "$tmp_shaped" "$tmp_output"

                    return 0
                else
                    echo -e "${YELLOW}No previous shaped file found, proceeding with shape generation despite matching content${NC}"
                fi
            else
                echo -e "${BLUE}Use --force flag to generate shapes anyway.${NC}"
                cp "$gtfs_file" "$previous_lite_file"
                return 0
            fi
        else
            echo -e "${BLUE}GTFS content differs. Proceeding with shape generation.${NC}"
        fi
    fi

    if [ -z "$osm_file" ]; then
        osm_file="$OSM_DIR/latest.osm"
    elif [ ! -f "$osm_file" ] && [ -f "$OSM_DIR/$(basename "$osm_file")" ]; then
        osm_file="$OSM_DIR/$(basename "$osm_file")"
    fi

    if [ ! -f "$osm_file" ]; then
        echo -e "${RED}Error: OSM file not found: $osm_file${NC}"
        exit 1
    fi

    local output_dir="$GTFS_SHAPED_DIR/$agency"
    local temp_zip="$GTFS_SHAPED_DIR/${agency}.zip"

    mkdir -p "$GTFS_SHAPED_DIR"

    echo -e "${BLUE}Adding shapes to $gtfs_file using OSM data from $osm_file${NC}"
    "$PFAEDLE_DIR/build/pfaedle" -c "$CONFIG_PATH" -x "$osm_file" -m bus "$gtfs_file" -o "$output_dir"

    if [ $? -eq 0 ]; then
        if [ "$overwrite" = true ] || [ "$backup" = true ]; then
            echo -e "${YELLOW}Creating zip file from shaped GTFS...${NC}"

            [ -f "$temp_zip" ] && rm "$temp_zip"

            (cd "$output_dir" && zip -r "$temp_zip" .)

            if [ $? -eq 0 ]; then
                 if [ "$backup" = true ]; then
                    echo -e "${YELLOW}Backing up original GTFS file...${NC}"
                    local backup_file="${gtfs_file%.zip}.lite.zip"
                    cp "$gtfs_file" "$backup_file"
                    echo -e "${GREEN}Original GTFS backed up to $backup_file${NC}"
                 fi

                echo -e "${YELLOW}Overwriting original GTFS file...${NC}"
                cp "$temp_zip" "$gtfs_file"
                echo -e "${GREEN}Successfully overwrote $gtfs_file with shaped version${NC}"
             else
                echo -e "${RED}Failed to create zip file from shaped GTFS${NC}"
                exit 1
             fi
        else
            echo -e "${GREEN}New GTFS with shapes saved to $output_dir${NC}"
        fi
    else
        echo -e "${RED}Failed to add shapes to $gtfs_file${NC}"
        exit 1
    fi
}

process_all_gtfs() {
    if [ ! -d "$GTFS_DIR" ]; then
        echo -e "${RED}Error: GTFS directory not found: $GTFS_DIR${NC}"
        exit 1
    fi

    local overwrite=false
    local backup=false
    local force=false
    local max_parallel=$(nproc 2>/dev/null || echo 4)

    for arg in "$@"; do
        if [ "$arg" = "--overwrite" ]; then
            overwrite=true
        elif [ "$arg" = "--backup" ]; then
            backup=true
        elif [ "$arg" = "--force" ]; then
            force=true
        elif [[ "$arg" =~ ^--jobs=([0-9]+)$ ]]; then
            max_parallel="${BASH_REMATCH[1]}"
        fi
    done

    local osm_file="$OSM_DIR/latest.osm"
    local total_files=$(find "$GTFS_DIR" -type f -name "*.zip" -not -name "*.lite.zip" | wc -l)

    if [ "$total_files" -eq 0 ]; then
        echo -e "${RED}No GTFS files found in $GTFS_DIR${NC}"
        exit 1
    fi

    echo -e "${BLUE}Processing $total_files GTFS files with up to $max_parallel parallel jobs...${NC}"

    local status_dir="$MORPH_TMP_DIR/status"
    mkdir -p "$status_dir"

    rm -f "$status_dir/all_checksums_match"
    rm -f "$status_dir/files_processed"

    local tmp_dir=$(mktemp -d)
    local sem="$tmp_dir/semaphore"
    local result_file="$tmp_dir/results"

    echo "$total_files" > "$result_file"
    echo "0" >> "$result_file"

    mkfifo "$sem"
    exec 3<>"$sem"
    rm "$sem"

    for ((i=0; i<max_parallel; i++)); do
        echo >&3
    done

    pids=()

    while read -r gtfs_file; do
        read -u 3

        {
            local basename_file=$(basename "$gtfs_file")
            echo -e "${BLUE} Processing $basename_file${NC}"

            local cmd_args=""
            if [ "$overwrite" = true ]; then
                cmd_args="--overwrite"
            fi
            if [ "$backup" = true ]; then
                cmd_args="--backup"
            fi
            if [ "$force" = true ]; then
                cmd_args="$cmd_args --force"
            fi

            local output=$(add_shapes $cmd_args "$gtfs_file" "$osm_file" 2>&1)
            local status=$?

            echo "$output" | while IFS= read -r line; do
                echo -e "${BLUE}[${basename_file}]${NC} $line"
            done

            if echo "$output" | grep -q "Checksums match. Skipping shape generation"; then
                local skipped_files=$(tail -n 1 "$result_file")
                skipped_files=$((skipped_files + 1))
                sed -i '$d' "$result_file"
                echo "$skipped_files" >> "$result_file"
            fi

            if [ $status -eq 0 ]; then
                echo -e "${GREEN}Successfully processed $basename_file${NC}"
            else
                echo -e "${RED}Failed to process $basename_file${NC}"
            fi

            echo >&3
        } &

        pids+=($!)

    done < <(find "$GTFS_DIR" -type f -name "*.zip" -not -name "*.lite.zip")

    for pid in "${pids[@]}"; do
        wait $pid
    done

    exec 3>&-

    local total_count=$(head -n 1 "$result_file")
    local skipped_count=$(tail -n 1 "$result_file")

    echo -e "${BLUE}Files processed: $total_count, Files skipped due to checksums: $skipped_count${NC}"

    if [ "$total_count" -eq "$skipped_count" ]; then
        echo "true" > "$status_dir/all_checksums_match"
        echo -e "${GREEN}All files had matching checksums. No shape generation was needed.${NC}"
    else
        echo "skipped_count of $total_count files skipped due to matching checksums" > "$status_dir/files_processed"
        echo -e "${GREEN}Shapes were generated for $((total_count - skipped_count)) files.${NC}"
    fi

    rm -rf "$tmp_dir"

    echo -e "${GREEN}All $total_files GTFS files processed${NC}"
}

case "$1" in
    init)
        build_pfaedle
        download_osm
        ;;
    add)
        shift
        add_shapes "$@"
        ;;
    all)
        shift
        process_all_gtfs "$@"
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        show_help
        exit 1
        ;;
esac
