#!/bin/bash

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
MORPH_DIR="$SCRIPT_DIR"
PFAEDLE_DIR="$MORPH_DIR/pfaedle"
MORPH_TMP_DIR="$MORPH_DIR/../.tmp/morph"
OSM_DIR="$MORPH_TMP_DIR/osm"
GTFS_SHAPED_DIR="$MORPH_TMP_DIR/shaped"
CONFIG_PATH="$MORPH_DIR/pfaedle.cfg"
GTFS_DIR="$MORPH_DIR/../gtfs"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${BLUE}Morph GTFS Shape Generator${NC}"
    echo ""
    echo "Usage: shapes [command] [options]"
    echo ""
    echo "Commands:"
    echo "  init              Build pfaedle and download OSM data"
    echo "  add [options] [gtfs] [osm]  Add shapes to a GTFS file"
    echo "  all [options]     Process all GTFS files"
    echo ""
    echo "Options for 'add' and 'all':"
    echo "  --overwrite       Replace the original GTFS file with the shaped version"
    echo ""
    echo "Arguments:"
    echo "  [gtfs]            Path to GTFS file"
    echo "  [osm]             Path to OSM file (default: .tmp/morph/osm/slovakia-latest.osm.bz2)"
}

build_pfaedle() {
    if [ ! -f "$PFAEDLE_DIR/build/pfaedle" ]; then
        echo -e "${BLUE}Building pfaedle...${NC}"
        mkdir -p "$PFAEDLE_DIR/build"
        cd "$PFAEDLE_DIR/build" || exit 1
        cmake ..
        make -j
        cd - > /dev/null || exit 1
        echo -e "${GREEN}pfaedle built successfully${NC}"
    else
        echo -e "${GREEN}pfaedle already built${NC}"
    fi
}

download_osm() {
    local osm_file="$OSM_DIR/slovakia-latest.osm.bz2"

    if [ ! -f "$osm_file" ]; then
        echo -e "${BLUE}Downloading OSM data for Slovakia...${NC}"
        mkdir -p "$OSM_DIR"
        wget -q --show-progress https://download.geofabrik.de/europe/slovakia-latest.osm.bz2 -O "$osm_file"
        echo -e "${GREEN}OSM data downloaded${NC}"
    else
        echo -e "${GREEN}OSM data already exists${NC}"
    fi
}

add_shapes() {
    local overwrite=false
    local args=()

    for arg in "$@"; do
        if [ "$arg" = "--overwrite" ]; then
            overwrite=true
        else
            args+=("$arg")
        fi
    done

    local gtfs_file="${args[0]}"
    local osm_file="${args[1]}"

    if [ -z "$gtfs_file" ]; then
        echo -e "${RED}Error: GTFS file not specified${NC}"
        show_help
        exit 1
    fi

    if [ ! -f "$gtfs_file" ]; then
        echo -e "${RED}Error: GTFS file not found: $gtfs_file${NC}"
        exit 1
    fi

    if [ -z "$osm_file" ]; then
        osm_file="$OSM_DIR/slovakia-latest.osm.bz2"
    elif [ ! -f "$osm_file" ] && [ -f "$OSM_DIR/$(basename "$osm_file")" ]; then
        osm_file="$OSM_DIR/$(basename "$osm_file")"
    fi

    if [ ! -f "$osm_file" ]; then
        echo -e "${RED}Error: OSM file not found: $osm_file${NC}"
        exit 1
    fi

    local agency=$(basename "$gtfs_file" .zip)
    local output_dir="$GTFS_SHAPED_DIR/$agency"
    local temp_zip="$GTFS_SHAPED_DIR/${agency}.zip"

    mkdir -p "$GTFS_SHAPED_DIR"

    echo -e "${BLUE}Adding shapes to $gtfs_file using OSM data from $osm_file${NC}"
    "$PFAEDLE_DIR/build/pfaedle" -c "$CONFIG_PATH" -x "$osm_file" -m bus "$gtfs_file" -o "$output_dir"

    if [ $? -eq 0 ]; then
        if [ "$overwrite" = true ]; then
            echo -e "${YELLOW}Creating zip file from shaped GTFS...${NC}"

            [ -f "$temp_zip" ] && rm "$temp_zip"

            (cd "$output_dir" && zip -r "$temp_zip" .)

            if [ $? -eq 0 ]; then
                echo -e "${YELLOW}Overwriting original GTFS file...${NC}"
                cp "$temp_zip" "$gtfs_file"
                echo -e "${GREEN}Successfully overwrote $gtfs_file with shaped version${NC}"
            else
                echo -e "${RED}Failed to create zip file from shaped GTFS${NC}"
                exit 1
            fi
        else
            echo -e "${GREEN}New GTFS with shapes saved to $output_dir${NC}"
        fi
    else
        echo -e "${RED}Failed to add shapes to $gtfs_file${NC}"
        exit 1
    fi
}

process_all_gtfs() {
    if [ ! -d "$GTFS_DIR" ]; then
        echo -e "${RED}Error: GTFS directory not found: $GTFS_DIR${NC}"
        exit 1
    fi

    local overwrite=false

    for arg in "$@"; do
        if [ "$arg" = "--overwrite" ]; then
            overwrite=true
            break
        fi
    done

    local osm_file="$OSM_DIR/slovakia-latest.osm.bz2"
    local total_files=0
    local processed_files=0

    echo -e "${BLUE}Scanning for GTFS files...${NC}"
    total_files=$(find "$GTFS_DIR" -type f -name "*.zip" | wc -l)

    if [ "$total_files" -eq 0 ]; then
        echo -e "${RED}No GTFS files found in $GTFS_DIR${NC}"
        exit 1
    fi

    echo -e "${BLUE}Processing $total_files GTFS files...${NC}"

    find "$GTFS_DIR" -type f -name "*.zip" | while read -r gtfs_file; do
        processed_files=$((processed_files + 1))
        echo -e "${BLUE}[$processed_files/$total_files] Processing $(basename "$gtfs_file")${NC}"

        if [ "$overwrite" = true ]; then
            add_shapes "--overwrite" "$gtfs_file" "$osm_file"
        else
            add_shapes "$gtfs_file" "$osm_file"
        fi
    done

    echo -e "${GREEN}All $total_files GTFS files processed successfully${NC}"
}

case "$1" in
    init)
        build_pfaedle
        download_osm
        ;;
    add)
        shift
        add_shapes "$@"
        ;;
    all)
        shift
        process_all_gtfs "$@"
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        show_help
        exit 1
        ;;
esac
